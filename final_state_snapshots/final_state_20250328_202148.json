{
    "data_source": {
        "type": "snowflake",
        "database": "SAMPLE_DB",
        "schema": "SAMPLE_SCHEMA",
        "tables": [
            "SALES_TRANSACTIONS",
            "CUSTOMER_DIM",
            "PRODUCT_DIM"
        ],
        "available_tables": [
            "CALIFORNIA_HOUSING_TRAIN",
            "CLEANED_DF",
            "SAMPLE_TABLE",
            "PRODUCT_DIM",
            "SAMPLE_DF",
            "ANKIT",
            "CALIFORNIA_HOUSING_TEST",
            "CUSTOMER_DIM",
            "NEW_TABLE",
            "SALES_TRANSACTIONS"
        ]
    },
    "current_step": "schedule_task",
    "approval_status": "approved",
    "sample_data": {
        "SALES_TRANSACTIONS": [
            {
                "order_id": "146740",
                "product_id": "614",
                "cust_id": "121960",
                "product_quantity": "1",
                "order_date": "2019-01-24"
            },
            {
                "order_id": "141749",
                "product_id": "394",
                "cust_id": "113809",
                "product_quantity": "1",
                "order_date": "2019-01-24"
            },
            {
                "order_id": "144400",
                "product_id": "953",
                "cust_id": "102255",
                "product_quantity": "1",
                "order_date": "2019-01-24"
            },
            {
                "order_id": "148898",
                "product_id": "715",
                "cust_id": "190891",
                "product_quantity": "1",
                "order_date": "2019-01-24"
            },
            {
                "order_id": "143260",
                "product_id": "467",
                "cust_id": "108376",
                "product_quantity": "1",
                "order_date": "2019-01-24"
            }
        ],
        "CUSTOMER_DIM": [
            {
                "cust_id": "185057",
                "cust_address": "335 Meadow St, Los Angeles, CA 90001",
                "cust_age": "15",
                "effective_start_date": "1900-01-01",
                "effective_end_date": "9999-12-31",
                "current_ind": "Y"
            },
            {
                "cust_id": "225569",
                "cust_address": "753 Adams St, Portland, ME 04101",
                "cust_age": "15",
                "effective_start_date": "1900-01-01",
                "effective_end_date": "9999-12-31",
                "current_ind": "Y"
            },
            {
                "cust_id": "134924",
                "cust_address": "295 Dogwood St, New York City, NY 10001",
                "cust_age": "15",
                "effective_start_date": "1900-01-01",
                "effective_end_date": "9999-12-31",
                "current_ind": "Y"
            },
            {
                "cust_id": "218931",
                "cust_address": "40 Jefferson St, Atlanta, GA 30301",
                "cust_age": "15",
                "effective_start_date": "1900-01-01",
                "effective_end_date": "9999-12-31",
                "current_ind": "Y"
            },
            {
                "cust_id": "140361",
                "cust_address": "169 Lake St, Boston, MA 02215",
                "cust_age": "15",
                "effective_start_date": "1900-01-01",
                "effective_end_date": "9999-12-31",
                "current_ind": "Y"
            }
        ],
        "PRODUCT_DIM": [
            {
                "product_id": "582",
                "product_name": "iPhone",
                "product_price": "635.0",
                "effective_start_date": "2019-10-01",
                "effective_end_date": "2019-11-30",
                "current_ind": "N"
            },
            {
                "product_id": "582",
                "product_name": "iPhone",
                "product_price": "689.0",
                "effective_start_date": "2019-06-01",
                "effective_end_date": "2019-09-30",
                "current_ind": "N"
            },
            {
                "product_id": "582",
                "product_name": "iPhone",
                "product_price": "649.0",
                "effective_start_date": "2019-04-01",
                "effective_end_date": "2019-05-31",
                "current_ind": "N"
            },
            {
                "product_id": "582",
                "product_name": "iPhone",
                "product_price": "700.0",
                "effective_start_date": "1900-01-01",
                "effective_end_date": "2019-03-31",
                "current_ind": "N"
            },
            {
                "product_id": "216",
                "product_name": "LG Dryer",
                "product_price": "610.0",
                "effective_start_date": "2019-06-01",
                "effective_end_date": "2019-06-30",
                "current_ind": "N"
            }
        ]
    },
    "sql_logic": {
        "problem_statement": "Create a SQL table named fact_sales_enriched by joining the sales_transactions fact table with the historical customer_dimension and product_dimension tables based on the order_date. Ensure you fetch the correct customer and product records valid at the time of the transaction (SCD Type 2 logic). Include total amount as price \u00d7 quantity.",
        "generated_sql": "```sql\nCREATE TABLE fact_sales_enriched AS\nSELECT \n    st.order_date,\n    st.order_id,\n    cd.customer_id,\n    cd.customer_name,\n    pd.product_id,\n    pd.product_name,\n    st.price,\n    st.quantity,\n    (st.price * st.quantity) AS total_amount\nFROM \n    SALES_TRANSACTIONS st\nJOIN \n    CUSTOMER_DIM cd ON st.customer_id = cd.customer_id\n    AND st.order_date BETWEEN cd.effective_date AND COALESCE(cd.expiration_date, '9999-12-31')\nJOIN \n    PRODUCT_DIM pd ON st.product_id = pd.product_id\n    AND st.order_date BETWEEN pd.effective_date AND COALESCE(pd.expiration_date, '9999-12-31');\n```"
    },
    "sop_sql": {
        "original_sql": "```sql\nCREATE TABLE fact_sales_enriched AS\nSELECT \n    st.order_date,\n    st.order_id,\n    cd.customer_id,\n    cd.customer_name,\n    pd.product_id,\n    pd.product_name,\n    st.price,\n    st.quantity,\n    (st.price * st.quantity) AS total_amount\nFROM \n    SALES_TRANSACTIONS st\nJOIN \n    CUSTOMER_DIM cd ON st.customer_id = cd.customer_id\n    AND st.order_date BETWEEN cd.effective_date AND COALESCE(cd.expiration_date, '9999-12-31')\nJOIN \n    PRODUCT_DIM pd ON st.product_id = pd.product_id\n    AND st.order_date BETWEEN pd.effective_date AND COALESCE(pd.expiration_date, '9999-12-31');\n```",
        "refined_sql": "CREATE TABLE fact_sales_enriched AS\nSELECT \n    st.order_date            AS sales_date,\n    st.order_id              AS sales_order_id,\n    cd.customer_id           AS customer_key,\n    cd.customer_name          AS customer_name,\n    pd.product_id             AS product_key,\n    pd.product_name           AS product_description,\n    st.price                  AS sales_price,\n    st.quantity               AS sales_quantity,\n    (st.price * st.quantity)  AS total_sales_amount\nFROM \n    SALES_TRANSACTIONS st\nINNER JOIN \n    CUSTOMER_DIM cd\n    ON st.customer_id = cd.customer_id\n    AND st.order_date BETWEEN cd.effective_date AND COALESCE(cd.expiration_date, '9999-12-31')\nINNER JOIN \n    PRODUCT_DIM pd\n    ON st.product_id = pd.product_id\n    AND st.order_date BETWEEN pd.effective_date AND COALESCE(pd.expiration_date, '9999-12-31');"
    },
    "task_status": {
        "task_name": "SALES_TASK",
        "scheduled": true,
        "sql": "\nCREATE OR REPLACE TASK \"SAMPLE_DB\".\"SAMPLE_SCHEMA\".\"SALES_TASK\"\n    WAREHOUSE = COMPUTE_WH\n    SCHEDULE = '1 hour'\nAS\nCREATE TABLE fact_sales_enriched AS\nSELECT \n    st.order_date            AS sales_date,\n    st.order_id              AS sales_order_id,\n    cd.customer_id           AS customer_key,\n    cd.customer_name          AS customer_name,\n    pd.product_id             AS product_key,\n    pd.product_name           AS product_description,\n    st.price                  AS sales_price,\n    st.quantity               AS sales_quantity,\n    (st.price * st.quantity)  AS total_sales_amount\nFROM \n    SALES_TRANSACTIONS st\nINNER JOIN \n    CUSTOMER_DIM cd\n    ON st.customer_id = cd.customer_id\n    AND st.order_date BETWEEN cd.effective_date AND COALESCE(cd.expiration_date, '9999-12-31')\nINNER JOIN \n    PRODUCT_DIM pd\n    ON st.product_id = pd.product_id\n    AND st.order_date BETWEEN pd.effective_date AND COALESCE(pd.expiration_date, '9999-12-31');\n        "
    }
}